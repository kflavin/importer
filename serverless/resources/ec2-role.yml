---
Type: "AWS::IAM::Role"
Properties:
  AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "ec2.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
  Path: "/"
  Policies: 
    - 
      PolicyName: "ec2-importer2"
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          # EC2
          - Effect: Allow
            Action: "ec2:*"
            Resource: "*"
          - Effect: Allow
            Action:
              - "cloudwatch:PutMetricData"
              - "ds:CreateComputer"
              - "ds:DescribeDirectories"
              - "ec2:DescribeInstanceStatus"
              - "logs:*"
              - "ec2messages:*"
            Resource: "*"
          # SSM
          - Effect: Allow
            Action: "iam:CreateServiceLinkedRole"
            Resource: "arn:aws:iam::*:role/aws-service-role/ssm.amazonaws.com/AWSServiceRoleForAmazonSSM*"
            Condition:
              StringLike:
                "iam:AWSServiceName": "ssm.amazonaws.com"
          - Effect: Allow
            Action:
              - "iam:DeleteServiceLinkedRole"
              - "iam:GetServiceLinkedRoleDeletionStatus"
            Resource: "arn:aws:iam::*:role/aws-service-role/ssm.amazonaws.com/AWSServiceRoleForAmazonSSM*"
          - Effect: Allow
            Action:
              - "iam:PassRole"
              - "ec2:DescribeSecurityGroups"
              - "ec2:DescribeSubnets"
              - "ec2:DescribeVpcs"
            Resource: "*"
          # S3
          - Effect: Allow
            Action: "s3:*"
            Resource:
              - {"Fn::GetAtt": ["ScriptBucket","Arn"]}
              - "Fn::Join":
                  - ""
                  -
                    - {"Fn::GetAtt": ["ScriptBucket","Arn"]}
                    - "/*"
          - Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:ListMultipartUploadParts"
            Resource:
              - "Fn::Join":
                  - ""
                  - - "arn:aws:s3:::"
                    - ${self:provider.environment.aws_db_backup_s3_bucket}
              - "Fn::Join":
                  - ""
                  - - "arn:aws:s3:::"
                    - ${self:provider.environment.aws_db_backup_s3_bucket}
                    - "/*"
              - {"Fn::GetAtt": ["DbBackupBucket","Arn"]}
              - "Fn::Join":
                  - ""
                  - - {"Fn::GetAtt": ["DbBackupBucket","Arn"]}
                    - "/backups/*"
              - "Fn::Join":
                  - ""
                  - - {"Fn::GetAtt": ["DbBackupBucket","Arn"]}
                    - "/backups"
          - Effect: Allow
            Action:
              - "sns:Publish"
            Resource: ${file(./serverless/serverless.env.yml):${self:custom.environment}.aws_sns_topic_arn}
          - Effect: Allow
            Action: "s3:ListBucket"
            Resource: "arn:aws:s3:::rxv-product-data"
          - Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:DeleteObject"
            Resource: "arn:aws:s3:::rxv-product-data/*"
          - Effect: Allow
            Action:
              - "sns:Publish"
            Resource: "arn:aws:sns:us-east-1:*:data-importer-*"
          - Effect: Allow
            Action:
              - "ssm:Describe*"
              - "ssm:Get*"
              - "ssm:List*"
            Resource: "arn:aws:ssm:*:*:parameter/importer/*"
          
